{%- comment -%}
  Shopify Markets Location Flag Display
  Shows the current country flag based on user's detected location
  Uses Shopify Markets API - detects country from market or currency
{%- endcomment -%}

{%- liquid
  assign detected_country_code = ''
  assign detected_country_name = ''
  
  comment Detect country from Markets
  if localization.country
    assign detected_country_code = localization.country.iso_code | upcase
    assign detected_country_name = localization.country.name
  elsif localization.available_countries.size > 0
    comment Use first available country from market
    assign detected_country_code = localization.available_countries.first.iso_code | upcase
    assign detected_country_name = localization.available_countries.first.name
  elsif cart.currency.iso_code
    comment Infer country from currency as fallback
    case cart.currency.iso_code
      when 'GBP'
        assign detected_country_code = 'GB'
        assign detected_country_name = 'United Kingdom'
      when 'USD'
        assign detected_country_code = 'US'
        assign detected_country_name = 'United States'
      when 'EUR'
        assign detected_country_code = 'EU'
        assign detected_country_name = 'European Union'
      when 'CAD'
        assign detected_country_code = 'CA'
        assign detected_country_name = 'Canada'
      when 'AUD'
        assign detected_country_code = 'AU'
        assign detected_country_name = 'Australia'
      when 'JPY'
        assign detected_country_code = 'JP'
        assign detected_country_name = 'Japan'
      when 'CHF'
        assign detected_country_code = 'CH'
        assign detected_country_name = 'Switzerland'
      else
        assign detected_country_code = cart.currency.iso_code
        assign detected_country_name = cart.currency.iso_code
    endcase
  endif
-%}

{%- if detected_country_code != '' -%}
<div class="markets-location-flag" data-country-code="{{ detected_country_code | downcase }}">
  <span class="location-flag-icon" aria-label="{{ detected_country_name }}" title="{{ detected_country_name }}">
    {%- comment -%} Direct mapping of country codes to flag emojis for reliability {%- endcomment -%}
    {%- assign country_code = detected_country_code -%}
    {%- assign flag_emoji = '' -%}
    
    {%- case country_code -%}
      {%- when 'US' -%}{%- assign flag_emoji = 'ğŸ‡ºğŸ‡¸' -%}
      {%- when 'GB' -%}{%- assign flag_emoji = 'ğŸ‡¬ğŸ‡§' -%}
      {%- when 'UK' -%}{%- assign flag_emoji = 'ğŸ‡¬ğŸ‡§' -%}
      {%- when 'CA' -%}{%- assign flag_emoji = 'ğŸ‡¨ğŸ‡¦' -%}
      {%- when 'AU' -%}{%- assign flag_emoji = 'ğŸ‡¦ğŸ‡º' -%}
      {%- when 'DE' -%}{%- assign flag_emoji = 'ğŸ‡©ğŸ‡ª' -%}
      {%- when 'FR' -%}{%- assign flag_emoji = 'ğŸ‡«ğŸ‡·' -%}
      {%- when 'IT' -%}{%- assign flag_emoji = 'ğŸ‡®ğŸ‡¹' -%}
      {%- when 'ES' -%}{%- assign flag_emoji = 'ğŸ‡ªğŸ‡¸' -%}
      {%- when 'NL' -%}{%- assign flag_emoji = 'ğŸ‡³ğŸ‡±' -%}
      {%- when 'BE' -%}{%- assign flag_emoji = 'ğŸ‡§ğŸ‡ª' -%}
      {%- when 'CH' -%}{%- assign flag_emoji = 'ğŸ‡¨ğŸ‡­' -%}
      {%- when 'AT' -%}{%- assign flag_emoji = 'ğŸ‡¦ğŸ‡¹' -%}
      {%- when 'SE' -%}{%- assign flag_emoji = 'ğŸ‡¸ğŸ‡ª' -%}
      {%- when 'NO' -%}{%- assign flag_emoji = 'ğŸ‡³ğŸ‡´' -%}
      {%- when 'DK' -%}{%- assign flag_emoji = 'ğŸ‡©ğŸ‡°' -%}
      {%- when 'FI' -%}{%- assign flag_emoji = 'ğŸ‡«ğŸ‡®' -%}
      {%- when 'PL' -%}{%- assign flag_emoji = 'ğŸ‡µğŸ‡±' -%}
      {%- when 'IE' -%}{%- assign flag_emoji = 'ğŸ‡®ğŸ‡ª' -%}
      {%- when 'PT' -%}{%- assign flag_emoji = 'ğŸ‡µğŸ‡¹' -%}
      {%- when 'GR' -%}{%- assign flag_emoji = 'ğŸ‡¬ğŸ‡·' -%}
      {%- when 'CZ' -%}{%- assign flag_emoji = 'ğŸ‡¨ğŸ‡¿' -%}
      {%- when 'HU' -%}{%- assign flag_emoji = 'ğŸ‡­ğŸ‡º' -%}
      {%- when 'RO' -%}{%- assign flag_emoji = 'ğŸ‡·ğŸ‡´' -%}
      {%- when 'JP' -%}{%- assign flag_emoji = 'ğŸ‡¯ğŸ‡µ' -%}
      {%- when 'CN' -%}{%- assign flag_emoji = 'ğŸ‡¨ğŸ‡³' -%}
      {%- when 'KR' -%}{%- assign flag_emoji = 'ğŸ‡°ğŸ‡·' -%}
      {%- when 'IN' -%}{%- assign flag_emoji = 'ğŸ‡®ğŸ‡³' -%}
      {%- when 'BR' -%}{%- assign flag_emoji = 'ğŸ‡§ğŸ‡·' -%}
      {%- when 'MX' -%}{%- assign flag_emoji = 'ğŸ‡²ğŸ‡½' -%}
      {%- when 'AR' -%}{%- assign flag_emoji = 'ğŸ‡¦ğŸ‡·' -%}
      {%- when 'ZA' -%}{%- assign flag_emoji = 'ğŸ‡¿ğŸ‡¦' -%}
      {%- when 'NZ' -%}{%- assign flag_emoji = 'ğŸ‡³ğŸ‡¿' -%}
      {%- when 'SG' -%}{%- assign flag_emoji = 'ğŸ‡¸ğŸ‡¬' -%}
      {%- when 'MY' -%}{%- assign flag_emoji = 'ğŸ‡²ğŸ‡¾' -%}
      {%- when 'TH' -%}{%- assign flag_emoji = 'ğŸ‡¹ğŸ‡­' -%}
      {%- when 'PH' -%}{%- assign flag_emoji = 'ğŸ‡µğŸ‡­' -%}
      {%- when 'ID' -%}{%- assign flag_emoji = 'ğŸ‡®ğŸ‡©' -%}
      {%- when 'VN' -%}{%- assign flag_emoji = 'ğŸ‡»ğŸ‡³' -%}
      {%- when 'TR' -%}{%- assign flag_emoji = 'ğŸ‡¹ğŸ‡·' -%}
      {%- when 'SA' -%}{%- assign flag_emoji = 'ğŸ‡¸ğŸ‡¦' -%}
      {%- when 'AE' -%}{%- assign flag_emoji = 'ğŸ‡¦ğŸ‡ª' -%}
      {%- when 'IL' -%}{%- assign flag_emoji = 'ğŸ‡®ğŸ‡±' -%}
      {%- when 'RU' -%}{%- assign flag_emoji = 'ğŸ‡·ğŸ‡º' -%}
      {%- when 'UA' -%}{%- assign flag_emoji = 'ğŸ‡ºğŸ‡¦' -%}
      {%- else -%}
        {%- comment -%} Fallback: Try to construct flag from country code letters {%- endcomment -%}
        {%- assign char1 = country_code | slice: 0, 1 -%}
        {%- assign char2 = country_code | slice: 1, 1 -%}
        {%- assign flag_part1 = '' -%}
        {%- assign flag_part2 = '' -%}
        {%- case char1 -%}
          {%- when 'A' -%}{%- assign flag_part1 = 'ğŸ‡¦' -%}
          {%- when 'B' -%}{%- assign flag_part1 = 'ğŸ‡§' -%}
          {%- when 'C' -%}{%- assign flag_part1 = 'ğŸ‡¨' -%}
          {%- when 'D' -%}{%- assign flag_part1 = 'ğŸ‡©' -%}
          {%- when 'E' -%}{%- assign flag_part1 = 'ğŸ‡ª' -%}
          {%- when 'F' -%}{%- assign flag_part1 = 'ğŸ‡«' -%}
          {%- when 'G' -%}{%- assign flag_part1 = 'ğŸ‡¬' -%}
          {%- when 'H' -%}{%- assign flag_part1 = 'ğŸ‡­' -%}
          {%- when 'I' -%}{%- assign flag_part1 = 'ğŸ‡®' -%}
          {%- when 'J' -%}{%- assign flag_part1 = 'ğŸ‡¯' -%}
          {%- when 'K' -%}{%- assign flag_part1 = 'ğŸ‡°' -%}
          {%- when 'L' -%}{%- assign flag_part1 = 'ğŸ‡±' -%}
          {%- when 'M' -%}{%- assign flag_part1 = 'ğŸ‡²' -%}
          {%- when 'N' -%}{%- assign flag_part1 = 'ğŸ‡³' -%}
          {%- when 'O' -%}{%- assign flag_part1 = 'ğŸ‡´' -%}
          {%- when 'P' -%}{%- assign flag_part1 = 'ğŸ‡µ' -%}
          {%- when 'Q' -%}{%- assign flag_part1 = 'ğŸ‡¶' -%}
          {%- when 'R' -%}{%- assign flag_part1 = 'ğŸ‡·' -%}
          {%- when 'S' -%}{%- assign flag_part1 = 'ğŸ‡¸' -%}
          {%- when 'T' -%}{%- assign flag_part1 = 'ğŸ‡¹' -%}
          {%- when 'U' -%}{%- assign flag_part1 = 'ğŸ‡º' -%}
          {%- when 'V' -%}{%- assign flag_part1 = 'ğŸ‡»' -%}
          {%- when 'W' -%}{%- assign flag_part1 = 'ğŸ‡¼' -%}
          {%- when 'X' -%}{%- assign flag_part1 = 'ğŸ‡½' -%}
          {%- when 'Y' -%}{%- assign flag_part1 = 'ğŸ‡¾' -%}
          {%- when 'Z' -%}{%- assign flag_part1 = 'ğŸ‡¿' -%}
        {%- endcase -%}
        {%- case char2 -%}
          {%- when 'A' -%}{%- assign flag_part2 = 'ğŸ‡¦' -%}
          {%- when 'B' -%}{%- assign flag_part2 = 'ğŸ‡§' -%}
          {%- when 'C' -%}{%- assign flag_part2 = 'ğŸ‡¨' -%}
          {%- when 'D' -%}{%- assign flag_part2 = 'ğŸ‡©' -%}
          {%- when 'E' -%}{%- assign flag_part2 = 'ğŸ‡ª' -%}
          {%- when 'F' -%}{%- assign flag_part2 = 'ğŸ‡«' -%}
          {%- when 'G' -%}{%- assign flag_part2 = 'ğŸ‡¬' -%}
          {%- when 'H' -%}{%- assign flag_part2 = 'ğŸ‡­' -%}
          {%- when 'I' -%}{%- assign flag_part2 = 'ğŸ‡®' -%}
          {%- when 'J' -%}{%- assign flag_part2 = 'ğŸ‡¯' -%}
          {%- when 'K' -%}{%- assign flag_part2 = 'ğŸ‡°' -%}
          {%- when 'L' -%}{%- assign flag_part2 = 'ğŸ‡±' -%}
          {%- when 'M' -%}{%- assign flag_part2 = 'ğŸ‡²' -%}
          {%- when 'N' -%}{%- assign flag_part2 = 'ğŸ‡³' -%}
          {%- when 'O' -%}{%- assign flag_part2 = 'ğŸ‡´' -%}
          {%- when 'P' -%}{%- assign flag_part2 = 'ğŸ‡µ' -%}
          {%- when 'Q' -%}{%- assign flag_part2 = 'ğŸ‡¶' -%}
          {%- when 'R' -%}{%- assign flag_part2 = 'ğŸ‡·' -%}
          {%- when 'S' -%}{%- assign flag_part2 = 'ğŸ‡¸' -%}
          {%- when 'T' -%}{%- assign flag_part2 = 'ğŸ‡¹' -%}
          {%- when 'U' -%}{%- assign flag_part2 = 'ğŸ‡º' -%}
          {%- when 'V' -%}{%- assign flag_part2 = 'ğŸ‡»' -%}
          {%- when 'W' -%}{%- assign flag_part2 = 'ğŸ‡¼' -%}
          {%- when 'X' -%}{%- assign flag_part2 = 'ğŸ‡½' -%}
          {%- when 'Y' -%}{%- assign flag_part2 = 'ğŸ‡¾' -%}
          {%- when 'Z' -%}{%- assign flag_part2 = 'ğŸ‡¿' -%}
        {%- endcase -%}
        {%- assign flag_emoji = flag_part1 | append: flag_part2 -%}
    {%- endcase -%}
    
    <span class="flag-emoji">{{ flag_emoji }}</span>
    {%- if show_country_name -%}
      <span class="country-name">{{ detected_country_name }}</span>
    {%- endif -%}
  </span>
</div>

<style>
  .markets-location-flag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    cursor: default;
    margin-left: 8px;
  }
  
  .markets-location-flag .flag-emoji {
    font-size: 16px;
    line-height: 1;
    display: inline-block;
    vertical-align: middle;
  }
  
  .markets-location-flag .country-name {
    font-size: 11px;
    font-weight: 500;
    color: inherit;
    display: none;
  }
  
  .header__locationFlag {
    display: inline-flex;
    align-items: center;
    vertical-align: middle;
  }
  
  @media (max-width: 768px) {
    .markets-location-flag .flag-emoji {
      font-size: 14px;
    }
    
    .markets-location-flag {
      margin-left: 6px;
    }
  }
</style>
{%- endif -%}

